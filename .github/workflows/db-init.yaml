name: Run init.sql on production database

on:
  workflow_dispatch:   # ręczne uruchomienie

jobs:
  run-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Debug secrets (safe)
        run: |
          echo "POSTGRES_HOST length: ${#POSTGRES_HOST}"
          echo "POSTGRES_USER length: ${#POSTGRES_USER}"
          echo "POSTGRES_DB length: ${#POSTGRES_DB}"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}

      - name: Create .pgpass
        run: |
          echo "$POSTGRES_HOST:5432:$POSTGRES_DB:$POSTGRES_USER:$POSTGRES_PASSWORD" > ~/.pgpass
          chmod 600 ~/.pgpass
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}


      - name: Test DB connection
        run: |
          psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT current_database();" || \
          echo "❌ Connection failed"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}


      - name: Wait for DB to be ready
        env:
          PGHOST: ${{ secrets.POSTGRES_HOST }}
          PGUSER: ${{ secrets.POSTGRES_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGDATABASE: ${{ secrets.POSTGRES_DB }}
        run: |
          echo "Checking DB availability..."
          for i in {1..30}; do
            if psql -c "SELECT 1" >/dev/null 2>&1; then
              echo "✅ Database is ready"
              break
            fi
            echo "Database not ready yet... retry $i/30"
            sleep 2
          done

      - name: Run init.sql
        env:
          PGPASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: |
          echo "Executing init.sql..."
          psql \
            -h ${{ secrets.POSTGRES_HOST }} \
            -U ${{ secrets.POSTGRES_USER }} \
            -d ${{ secrets.POSTGRES_DB }} \
            -f database/init.sql
          echo "✅ init.sql executed successfully"
